
# ğŸ§ª ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢å±¥æ­´æ©Ÿèƒ½ - å®Ÿé¨“æ‰‹é †ã¨ã‚³ãƒ¼ãƒ‰å®Ÿè£…

ä½œæˆæ—¥ï¼š2025å¹´6æœˆ16æ—¥  
ä½œæˆè€…ï¼šJo  

---

## ğŸ”§ ã‚¹ãƒ†ãƒƒãƒ—1ï¼šDynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

### ğŸ¯ ç›®çš„  
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œç´¢å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ« `UserSearchHistory` ã‚’ä½œæˆã—ã¾ã™ã€‚

### ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

| å±æ€§å       | ã‚¿ã‚¤ãƒ—   | èª¬æ˜                     |
|--------------|----------|--------------------------|
| user_id      | String   | Cognito ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ IDï¼ˆsubï¼‰ |
| timestamp    | String   | ISO å½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— |
| keyword      | String   | æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰           |

### âœ… AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®ä½œæˆæ‰‹é †

1. DynamoDB ç®¡ç†ç”»é¢ã‚’é–‹ã  
2. ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹  
3. ãƒ†ãƒ¼ãƒ–ãƒ«åï¼š`UserSearchHistory`  
4. ä¸»ã‚­ãƒ¼è¨­å®šï¼š
   - ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ï¼š`user_id`ï¼ˆStringï¼‰
   - ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ï¼š`timestamp`ï¼ˆStringï¼‰
5. ãã®ä»–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®ã¾ã¾ â†’ ä½œæˆ

---

## ğŸ§  ã‚¹ãƒ†ãƒƒãƒ—2ï¼šLambda + FastAPI ã®é–‹ç™º

FastAPI ã«ã‚ˆã‚‹ Lambda é–¢æ•°ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®2ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›ï¼š

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜             |
|----------------|----------|------------------|
| `/search`      | POST     | æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜ |
| `/history`     | GET      | ãƒ¦ãƒ¼ã‚¶ãƒ¼å±¥æ­´ã‚’å–å¾—   |

---

### ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
lambda_package/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py         # FastAPI å®Ÿè£…
â”‚   â””â”€â”€ auth.py         # Cognito JWT è§£æ
â”œâ”€â”€ requirements.txt
â””â”€â”€ template.yaml       # ï¼ˆä»»æ„ï¼‰SAM ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```

---

### ğŸ“„ requirements.txt
```txt
fastapi
uvicorn
boto3
python-jose
aws-lambda-powertools
```

---

### ğŸ”‘ auth.pyï¼ˆJWT ã‹ã‚‰ user_id ã‚’å–å¾—ï¼‰

```python
from fastapi import Header, HTTPException
from jose import jwt

def get_user_id_from_token(authorization: str = Header(...)) -> str:
    try:
        token = authorization.split()[1]
        claims = jwt.get_unverified_claims(token)
        return claims["sub"]
    except Exception:
        raise HTTPException(status_code=401, detail="Invalid token")
```

---

### ğŸš€ main.pyï¼ˆLambda æœ¬ä½“ï¼‰

```python
from fastapi import FastAPI, Depends
from datetime import datetime
import boto3
from boto3.dynamodb.conditions import Key
from .auth import get_user_id_from_token

app = FastAPI()
dynamodb = boto3.resource("dynamodb")
table = dynamodb.Table("UserSearchHistory")

@app.post("/search")
def search(keyword: str, user_id: str = Depends(get_user_id_from_token)):
    item = {
        "user_id": user_id,
        "timestamp": datetime.utcnow().isoformat(),
        "keyword": keyword
    }
    table.put_item(Item=item)
    return {"status": "saved", "keyword": keyword}

@app.get("/history")
def get_history(user_id: str = Depends(get_user_id_from_token)):
    result = table.query(
        KeyConditionExpression=Key("user_id").eq(user_id),
        ScanIndexForward=False,
        Limit=50
    )
    return {"history": result["Items"]}
```

---

## â˜ï¸ ã‚¹ãƒ†ãƒƒãƒ—3ï¼šLambda + API Gateway ã®ãƒ‡ãƒ—ãƒ­ã‚¤

- æ‰‹å‹•ã§ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½œæˆå¯èƒ½  
- ã¾ãŸã¯ AWS SAM / Serverless Framework ã‚’ä½¿ç”¨ã—ãŸ IaC ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚å¯èƒ½  

å¿…è¦ãŒã‚ã‚Œã° `template.yaml` ã®ç”Ÿæˆã‚‚å¯èƒ½ã§ã™ã€‚

---

## ğŸ–¥ï¸ ã‚¹ãƒ†ãƒƒãƒ—4ï¼šReact ã‹ã‚‰ API ã‚’å‘¼ã³å‡ºã™

```tsx
import { Auth } from 'aws-amplify';
import axios from 'axios';

const callSearch = async (keyword: string) => {
  const session = await Auth.currentSession();
  const token = session.getIdToken().getJwtToken();

  await axios.post("https://your-api-id.execute-api.region.amazonaws.com/search", 
    { keyword }, 
    { headers: { Authorization: `Bearer ${token}` } }
  );
};

const fetchHistory = async () => {
  const session = await Auth.currentSession();
  const token = session.getIdToken().getJwtToken();

  const res = await axios.get("https://your-api-id.execute-api.region.amazonaws.com/history", {
    headers: { Authorization: `Bearer ${token}` }
  });
  return res.data.history;
};
```

---

## âœ… ä»Šå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—

- Lambda ZIP ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆæ”¯æ´ãŒå¿…è¦ã§ã‚ã‚Œã°å¯¾å¿œå¯èƒ½  
- CloudFormation / SAM ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆã‚‚æ”¯æ´å¯èƒ½  
- React å´ã®æ§‹æˆã‚’æ•™ãˆã¦ã„ãŸã ã‘ã‚Œã°ã€é€£æºæ–¹æ³•ã®ã‚³ãƒ¼ãƒ‰ã‚‚æº–å‚™å¯èƒ½ã§ã™  

æ¬¡ã«é€²ã‚ãŸã„ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Œã°ã€ãŠçŸ¥ã‚‰ã›ãã ã•ã„ï¼
